<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twibbonize Clone - Campaigns & Analytics</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        .canvas-container {
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .file-input { display: none; }
        .hidden-section { display: none !important; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 50;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-40">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href=window.location.pathname">
                <i class="ph ph-intersect text-2xl text-blue-600"></i>
                <span class="font-bold text-lg tracking-tight">TwibbonMaker</span>
            </div>
            <div class="flex gap-4 text-sm font-medium">
                <button onclick="router.navigateTo('dashboard')" class="text-slate-600 hover:text-blue-600">My Campaigns</button>
                <button onclick="router.navigateTo('create')" class="bg-blue-600 text-white px-3 py-1.5 rounded-full hover:bg-blue-700 transition">Create New</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-4xl mx-auto px-4 py-6 w-full">
        
        <!-- LOADING SPINNER -->
        <div id="loading" class="loading-overlay hidden-section">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>

        <!-- GLOBAL CONFIG WARNING (Moved outside of views to be always visible if needed) -->
        <div id="config-warning" class="hidden-section bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg text-sm mb-6 flex items-start gap-3 shadow-sm">
            <i class="ph ph-warning-circle text-xl mt-0.5 text-yellow-600"></i>
            <div>
                <strong class="font-bold">Setup Required:</strong> Firebase configuration is missing.
                <p class="mt-1 text-yellow-700">You are running in a deployed/local environment but haven't added your API keys yet.</p>
                <ul class="list-disc list-inside mt-2 ml-1 text-yellow-700/80 font-mono text-xs">
                    <li>Open <strong>index.html</strong> in your editor.</li>
                    <li>Find <code>const manualConfig = null;</code>.</li>
                    <li>Paste your Firebase config object there.</li>
                </ul>
            </div>
        </div>

        <!-- VIEW: DASHBOARD (List of user's campaigns) -->
        <div id="view-dashboard" class="hidden-section space-y-6">
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Dashboard</h1>
                    <p class="text-slate-500">Track your campaign performance</p>
                </div>
            </div>
            
            <div id="campaign-list" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                <!-- Campaign Cards Injected Here -->
            </div>
            
            <div id="empty-state" class="text-center py-12 hidden-section">
                <div class="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-folder-dashed text-3xl text-slate-400"></i>
                </div>
                <h3 class="text-lg font-medium text-slate-900">No campaigns yet</h3>
                <p class="text-slate-500 mb-6">Create your first campaign to start tracking analytics.</p>
                <button onclick="router.navigateTo('create')" class="text-blue-600 font-bold hover:underline">Create Now</button>
            </div>
        </div>

        <!-- VIEW: CREATE CAMPAIGN -->
        <div id="view-create" class="hidden-section max-w-xl mx-auto">
            <h1 class="text-2xl font-bold mb-6 text-center">Start a Campaign</h1>
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">Campaign Title</label>
                    <input type="text" id="campaign-title" placeholder="e.g., Save the Earth 2025" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">Custom Link (Optional)</label>
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 text-sm bg-slate-50 border border-slate-300 px-3 py-2 rounded-lg font-mono">?campaign_id=</span>
                        <input type="text" id="campaign-slug" placeholder="my-campaign-name" class="flex-grow px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-mono text-sm">
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Leave blank for auto-generated link. Use letters, numbers, and hyphens only.</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">Upload Frame</label>
                    <p class="text-xs text-slate-500 mb-3">Transparent PNG required. Max 1MB.</p>
                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition cursor-pointer relative">
                        <input type="file" id="create-frame-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/png">
                        <div id="frame-preview-area">
                            <i class="ph ph-upload-simple text-4xl text-slate-300 mb-2"></i>
                            <p class="text-sm text-slate-500 font-medium">Click to upload frame</p>
                        </div>
                    </div>
                </div>

                <button id="btn-publish" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-md hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    Publish Campaign
                </button>
            </div>
        </div>

        <!-- VIEW: SUCCESS (After Creation) -->
        <div id="view-success" class="hidden-section max-w-xl mx-auto text-center pt-10">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-check text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-900 mb-2">Campaign Live!</h2>
            <p class="text-slate-500 mb-6">Share this link with your supporters.</p>

            <div class="bg-white p-4 rounded-xl border border-slate-200 flex items-center gap-2 mb-6 shadow-sm">
                <input type="text" id="share-link-input" readonly class="flex-grow bg-slate-50 border-none text-slate-600 text-sm p-2 rounded focus:ring-0 font-mono">
                <button onclick="copyLink()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition">Copy</button>
            </div>

            <!-- Social Share Buttons -->
            <div class="flex justify-center gap-3 mb-8">
                <a id="share-wa" target="_blank" class="w-10 h-10 bg-[#25D366] text-white rounded-full flex items-center justify-center hover:opacity-90 transition">
                    <i class="ph ph-whatsapp-logo text-xl"></i>
                </a>
                <a id="share-twitter" target="_blank" class="w-10 h-10 bg-black text-white rounded-full flex items-center justify-center hover:opacity-90 transition">
                    <i class="ph ph-x-logo text-xl"></i>
                </a>
                <a id="share-fb" target="_blank" class="w-10 h-10 bg-[#1877F2] text-white rounded-full flex items-center justify-center hover:opacity-90 transition">
                    <i class="ph ph-facebook-logo text-xl"></i>
                </a>
                <a id="share-li" target="_blank" class="w-10 h-10 bg-[#0A66C2] text-white rounded-full flex items-center justify-center hover:opacity-90 transition">
                    <i class="ph ph-linkedin-logo text-xl"></i>
                </a>
            </div>

            <div class="flex gap-4 justify-center">
                <button onclick="router.navigateTo('dashboard')" class="text-slate-600 font-medium hover:text-blue-600">Go to Dashboard</button>
                <button onclick="viewMyCampaign()" class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold hover:bg-blue-700 transition">View Campaign</button>
            </div>
        </div>

        <!-- VIEW: SUPPORTER (The Editor) -->
        <div id="view-supporter" class="hidden-section max-w-xl mx-auto">
            <div class="text-center mb-6">
                <span class="bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Campaign</span>
                <h1 id="display-campaign-title" class="text-2xl font-bold mt-2">Loading...</h1>
                <p id="display-usage-count" class="text-sm text-slate-500 mt-1 flex items-center justify-center gap-1">
                    <i class="ph ph-users"></i> <span id="count-value">0</span> supporters
                </p>
            </div>

            <!-- Editor Card -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 mb-6">
                
                <!-- Canvas Wrapper -->
                <div class="flex justify-center mb-6 bg-slate-100 rounded-lg p-1 border border-dashed border-slate-300">
                    <canvas id="c" width="500" height="500"></canvas>
                </div>

                <!-- Controls -->
                <div class="space-y-4">
                    <!-- Only Photo Upload Needed (Frame is pre-loaded) -->
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm"><i class="ph ph-camera"></i></div>
                            <div>
                                <p class="font-semibold text-sm">Upload Your Photo</p>
                            </div>
                        </div>
                        <label class="cursor-pointer bg-white text-blue-600 px-4 py-2 rounded-md border border-blue-200 text-sm font-medium hover:bg-blue-50 transition shadow-sm">
                            Choose
                            <input type="file" id="upload-photo" class="file-input" accept="image/*">
                        </label>
                    </div>

                    <!-- Adjustments -->
                    <div id="controls-panel" class="hidden space-y-4 pt-2 border-t border-slate-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-minus text-slate-400"></i>
                            <input type="range" id="zoom-slider" min="0.1" max="3" step="0.05" value="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                            <i class="ph ph-plus text-slate-400"></i>
                        </div>
                    </div>

                    <button id="btn-download" disabled class="w-full py-3 bg-slate-300 text-slate-500 rounded-xl font-bold text-lg shadow-sm transition-all duration-300 flex items-center justify-center gap-2 cursor-not-allowed">
                        <i class="ph ph-download-simple"></i> Download & Support
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Added setDoc to imports
        import { getFirestore, collection, addDoc, setDoc, getDoc, getDocs, doc, updateDoc, increment, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & CONFIG ---
        let app, auth, db;
        let currentUser = null;
        let currentCampaignId = null;
        let isFirebaseActive = false;
        
        // ==========================================
        // CONFIGURATION FOR VERCEL / GITHUB PAGES
        // ==========================================
        // Replace 'null' below with your actual Firebase config object 
        // from Firebase Console -> Project Settings -> General -> Your Apps -> SDK setup and configuration.
        const manualConfig = {
            apiKey: "AIzaSyDmPT73QHeykt_uTX_0eCe8jGdC2pWE53U",
            authDomain: "twibbon-app-25541.firebaseapp.com",
            projectId: "twibbon-app-25541",
            storageBucket: "twibbon-app-25541.firebasestorage.app",
            messagingSenderId: "48085731702",
            appId: "1:48085731702:web:49525f008cc9ccefce5257"
        };
        
        // App ID for data namespacing (Optional, but good for separation)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-twibbon-app';

        // --- ROUTING LOGIC (Must be available immediately) ---
        window.router = {
            navigateTo: (viewName) => {
                // Hide all views
                ['view-dashboard', 'view-create', 'view-success', 'view-supporter'].forEach(id => {
                    document.getElementById(id).classList.add('hidden-section');
                });
                
                // Show requested view
                const view = document.getElementById('view-' + viewName);
                if (view) view.classList.remove('hidden-section');

                // Specific logic per view
                if (viewName === 'dashboard') loadDashboard();
            }
        };

        function handleRouting() {
            const urlParams = new URLSearchParams(window.location.search);
            const campaignId = urlParams.get('campaign_id');

            if (campaignId) {
                // SUPPORTER MODE
                loadCampaign(campaignId);
            } else {
                // CREATOR MODE (Default to Dashboard)
                router.navigateTo('dashboard');
            }
        }

        // --- FIREBASE INIT ---
        const initFirebase = async () => {
            try {
                let firebaseConfig;
                
                // 1. Try environment config (Gemini Canvas)
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } 
                // 2. Try manual config (Vercel/GitHub/Local)
                else if (manualConfig) {
                    firebaseConfig = manualConfig;
                }
                
                if (!firebaseConfig) {
                    throw new Error("No Firebase Config found");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseActive = true;

                // Auth Logic
                // If in Canvas with token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } 
                // If on Vercel/GitHub (no token) -> Anonymous Auth
                else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        handleRouting();
                    }
                });

            } catch (e) {
                console.warn("Firebase not initialized:", e);
                // Show Global Warning Banner
                document.getElementById('config-warning').classList.remove('hidden-section');
                
                // Disable Publish Button (UX Improvement)
                const pubBtn = document.getElementById('btn-publish');
                if(pubBtn) {
                    pubBtn.disabled = true;
                    pubBtn.innerHTML = "<i class='ph ph-lock-key mr-2'></i> Setup Required (See Warning)";
                    pubBtn.classList.add('bg-slate-400', 'cursor-not-allowed');
                    pubBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-md');
                }

                handleRouting(); // Allow routing anyway, but data won't load
            }
        };

        // Initialize!
        initFirebase();

        // --- FABRIC JS SETUP ---
        const canvas = new fabric.Canvas('c', {
            backgroundColor: '#f1f5f9',
            preserveObjectStacking: true,
            selection: false
        });
        let userPhoto = null;
        let frameOverlay = null;

        // --- CREATOR LOGIC ---
        
        // 1. Image Compression (Client-Side)
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const elem = document.createElement('canvas');
                        const scaleFactor = 800 / Math.max(img.width, img.height);
                        elem.width = img.width * Math.min(1, scaleFactor);
                        elem.height = img.height * Math.min(1, scaleFactor);
                        const ctx = elem.getContext('2d');
                        ctx.drawImage(img, 0, 0, elem.width, elem.height);
                        resolve(elem.toDataURL('image/png', 0.8));
                    };
                };
            });
        };

        // 2. Handle Frame Select for Preview
        let pendingFrameBase64 = null;
        const frameUploadInput = document.getElementById('create-frame-upload');
        if(frameUploadInput) {
            frameUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                document.getElementById('loading').classList.remove('hidden-section');
                try {
                    pendingFrameBase64 = await compressImage(file);
                    const previewArea = document.getElementById('frame-preview-area');
                    previewArea.innerHTML = `<img src="${pendingFrameBase64}" class="h-32 mx-auto object-contain border rounded bg-slate-100">`;
                } catch(err) {
                    alert("Error processing image");
                }
                document.getElementById('loading').classList.add('hidden-section');
            });
        }

        // 3. Publish Campaign
        document.getElementById('btn-publish').addEventListener('click', async () => {
            if (!isFirebaseActive) {
                alert("Cannot publish: Firebase configuration is missing.");
                return;
            }
            
            const title = document.getElementById('campaign-title').value;
            const customSlug = document.getElementById('campaign-slug').value.trim();

            if (!title || !pendingFrameBase64) {
                alert("Please add a title and a frame.");
                return;
            }

            document.getElementById('loading').classList.remove('hidden-section');

            try {
                // Prepare Data
                const campaignData = {
                    title: title,
                    frameBase64: pendingFrameBase64,
                    creatorId: currentUser.uid,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                };

                let docRef;

                // LOGIC: Use Custom Slug if provided
                if (customSlug) {
                    // Validate Slug (alphanumeric and dashes only)
                    const slugRegex = /^[a-zA-Z0-9-]+$/;
                    if (!slugRegex.test(customSlug)) {
                        alert("Custom Link can only contain letters, numbers, and hyphens.");
                        document.getElementById('loading').classList.add('hidden-section');
                        return;
                    }

                    // Check availability
                    const slugRef = doc(db, 'artifacts', appId, 'public', 'data', 'campaigns', customSlug);
                    const slugSnap = await getDoc(slugRef);
                    if (slugSnap.exists()) {
                        alert("This Custom Link is already taken. Please choose another.");
                        document.getElementById('loading').classList.add('hidden-section');
                        return;
                    }

                    // Set Doc with specific ID
                    await setDoc(slugRef, campaignData);
                    docRef = slugRef; // ID is the slug
                } else {
                    // Auto-generated ID
                    docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'campaigns'), campaignData);
                }

                // Generate Link
                currentCampaignId = docRef.id;
                const shareUrl = `${window.location.origin}${window.location.pathname}?campaign_id=${docRef.id}`;
                document.getElementById('share-link-input').value = shareUrl;
                
                // Update Social Links
                updateSocialLinks(shareUrl, title);

                router.navigateTo('success');
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Failed to create campaign. Please try again.");
            }
            document.getElementById('loading').classList.add('hidden-section');
        });

        // Helper to update social buttons
        function updateSocialLinks(url, title) {
            const encodedUrl = encodeURIComponent(url);
            const encodedTitle = encodeURIComponent("Support this campaign: " + title);

            document.getElementById('share-wa').href = `https://wa.me/?text=${encodedTitle}%20${encodedUrl}`;
            document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`;
            document.getElementById('share-fb').href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;
            document.getElementById('share-li').href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`;
        }

        // --- DASHBOARD LOGIC ---
        async function loadDashboard() {
            if (!isFirebaseActive) return; // Silent return if config missing
            if (!currentUser) return;
            
            document.getElementById('loading').classList.remove('hidden-section');
            const listEl = document.getElementById('campaign-list');
            listEl.innerHTML = ''; 

            try {
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'campaigns'),
                    where("creatorId", "==", currentUser.uid)
                );

                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    document.getElementById('empty-state').classList.remove('hidden-section');
                } else {
                    document.getElementById('empty-state').classList.add('hidden-section');
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition cursor-pointer";
                        card.onclick = () => {
                             window.location.href = `${window.location.pathname}?campaign_id=${doc.id}`;
                        };
                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <img src="${data.frameBase64}" class="w-16 h-16 rounded bg-slate-100 object-contain">
                                <div>
                                    <h3 class="font-bold text-slate-800 line-clamp-1">${data.title}</h3>
                                    <p class="text-sm text-slate-500 mt-1 mb-1 font-mono text-xs bg-slate-100 inline-block px-1 rounded">/${doc.id}</p>
                                    <p class="text-sm text-slate-500">
                                        <i class="ph ph-users-three mr-1"></i> 
                                        <span class="font-bold text-blue-600">${data.usageCount || 0}</span> supporters
                                    </p>
                                </div>
                            </div>
                        `;
                        listEl.appendChild(card);
                    });
                }
            } catch (e) {
                console.error("Error loading dashboard", e);
            }
            document.getElementById('loading').classList.add('hidden-section');
        }

        // --- SUPPORTER LOGIC ---
        async function loadCampaign(campaignId) {
            currentCampaignId = campaignId;
            document.getElementById('loading').classList.remove('hidden-section');
            
            if (!isFirebaseActive) {
                alert("Cannot load campaign: Firebase not configured.");
                document.getElementById('loading').classList.add('hidden-section');
                return;
            }
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'campaigns', campaignId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    document.getElementById('display-campaign-title').textContent = data.title;
                    document.getElementById('count-value').textContent = data.usageCount || 0;
                    
                    fabric.Image.fromURL(data.frameBase64, (img) => {
                        canvas.clear();
                        canvas.setBackgroundColor('#f1f5f9', canvas.renderAll.bind(canvas));
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                        img.scale(scale);
                        canvas.setOverlayImage(img, canvas.renderAll.bind(canvas), {
                            scaleX: canvas.width / img.width,
                            scaleY: canvas.height / img.height,
                            originX: 'left',
                            originY: 'top'
                        });
                    });

                    router.navigateTo('supporter');
                } else {
                    alert("Campaign not found!");
                    router.navigateTo('dashboard');
                }
            } catch (e) {
                console.error("Error fetching campaign:", e);
                alert("Could not load campaign.");
            }
            document.getElementById('loading').classList.add('hidden-section');
        }

        // --- EDITOR & DOWNLOAD LOGIC (Supporter) ---
        const controlsPanel = document.getElementById('controls-panel');
        const downloadBtn = document.getElementById('btn-download');
        const zoomSlider = document.getElementById('zoom-slider');

        document.getElementById('upload-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(f) {
                const data = f.target.result;
                if (userPhoto) canvas.remove(userPhoto);

                fabric.Image.fromURL(data, function(img) {
                    userPhoto = img;
                    const scale = Math.max(canvas.width / img.width, canvas.height / img.height) * 0.8;
                    userPhoto.scale(scale);
                    canvas.centerObject(userPhoto);
                    canvas.add(userPhoto);
                    canvas.sendToBack(userPhoto);
                    canvas.setActiveObject(userPhoto);
                    
                    controlsPanel.classList.remove('hidden');
                    downloadBtn.disabled = false;
                    downloadBtn.classList.remove('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
                    downloadBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-lg');
                    
                    zoomSlider.value = scale;
                    zoomSlider.min = scale * 0.1;
                    zoomSlider.max = scale * 3;
                });
            };
            reader.readAsDataURL(file);
        });

        zoomSlider.addEventListener('input', function() {
            if (userPhoto) {
                userPhoto.scale(parseFloat(this.value));
                canvas.requestRenderAll();
            }
        });

        downloadBtn.addEventListener('click', async function() {
            canvas.discardActiveObject();
            canvas.renderAll();
            const dataURL = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 2 });
            const link = document.createElement('a');
            link.download = `support-${currentCampaignId || 'twibbon'}.png`;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            if (isFirebaseActive && currentCampaignId) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'campaigns', currentCampaignId);
                    await updateDoc(docRef, {
                        usageCount: increment(1)
                    });
                    const countEl = document.getElementById('count-value');
                    countEl.innerText = parseInt(countEl.innerText) + 1;
                } catch (e) {
                    console.error("Error updating analytics", e);
                }
            }
        });

        // --- UTILS ---
        window.copyLink = () => {
            const copyText = document.getElementById("share-link-input");
            copyText.select();
            document.execCommand("copy");
            alert("Link copied!");
        };

        window.viewMyCampaign = () => {
             window.location.href = `${window.location.pathname}?campaign_id=${currentCampaignId}`;
        };

    </script>
</body>
</html>